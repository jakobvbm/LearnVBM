<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>📚 Lern-App (Quest Edition)</title>
    <meta name="theme-color" content="#667eea">

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="user-header" id="user-header" style="display:none">
        <div class="user-info">
            <span>👋 <span id="current-username">Spieler</span></span>
            <div class="points-display">🏆 <span id="user-points">0</span> Punkte</div>
            <div class="club-display" id="club-info">🏛️ <span id="user-club">Kein Club</span></div>
            <div class="admin-badge" id="admin-badge" style="display:none">👑 Admin</div>
            <div class="quest-notification" id="quest-notification" style="display:none" onclick="showQuestModal()">
                📋 <span id="pending-quests">0</span> Quests
            </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
            <button class="action-button info-btn" onclick="showSettingsScreen()">⚙️</button>
            <button class="logout-btn" onclick="logout()">Abmelden</button>
        </div>
    </div>

    <div class="container">
        <div id="login-screen" class="login-screen">
            <div class="card">
                <h1 style="text-align:center;font-size:2rem;margin-bottom:8px">📚 Lern-App</h1>
                <div class="login-form">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('login', event)">🔓 Anmelden</button>
                        <button class="tab-button" onclick="switchTab('register', event)">📝 Registrieren</button>
                    </div>

                    <div id="login-form">
                        <div class="form-group">
                            <label class="form-label">👤 Benutzername</label>
                            <input id="login-username" class="form-input" placeholder="Dein Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">🔒 Passwort</label>
                            <input id="login-password" type="password" class="form-input" placeholder="Dein Passwort">
                        </div>
                        <div style="display:flex;gap:8px;justify-content:center">
                            <button class="action-button check-btn" onclick="login()">🚀 Anmelden</button>
                        </div>
                    </div>
<script src="app.js"></script>
    
    memberCheckboxes.innerHTML = '';
    if(club && club.members){
        club.members.forEach(member => {
            if(member !== currentUser){
                const div = document.createElement('div');
                div.style.cssText = 'margin:5px 0;';
                div.innerHTML = `
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="checkbox" value="${member}" checked>
                        <span>${member}</span>
                    </label>
                `;
                memberCheckboxes.appendChild(div);
            }
        });
    }
    
    document.getElementById('quest-target').addEventListener('change', (e) => {
        memberSelection.style.display = e.target.value === 'specific' ? 'block' : 'none';
    });
}

let selectedQuestSubject = 'math';
let selectedDifficulty = 'easy';

function selectQuestSubject(subject, event){
    selectedQuestSubject = subject;
    document.querySelectorAll('.subject-tab').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
}

function selectDifficulty(difficulty, event){
    selectedDifficulty = difficulty;
    document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
}

function createQuest(){
    const title = document.getElementById('quest-title').value.trim();
    const count = parseInt(document.getElementById('quest-count').value);
    const target = document.getElementById('quest-target').value;
    
    if(!title){ alert('Bitte Quest-Titel eingeben'); return; }
    if(!count || count < 1){ alert('Bitte gültige Anzahl Aufgaben eingeben'); return; }
    
    let targetMembers = [];
    if(target === 'all'){
        const clubs = JSON.parse(localStorage.getItem('lernapp-clubs') || '{}');
        const club = clubs[currentUserData.clubId];
        targetMembers = club.members.filter(m => m !== currentUser);
    } else {
        const checkboxes = document.querySelectorAll('#member-checkboxes input[type="checkbox"]:checked');
        targetMembers = Array.from(checkboxes).map(cb => cb.value);
    }
    
    if(targetMembers.length === 0){ alert('Bitte mindestens ein Mitglied auswählen'); return; }
    
    const questId = 'quest_' + Date.now();
    const newQuest = {
        id: questId,
        title,
        subject: selectedQuestSubject,
        difficulty: selectedDifficulty,
        count,
        progress: 0,
        completed: false,
        createdBy: currentUser,
        createdAt: new Date().toISOString()
    };
    
    // Quest an alle Zielmitglieder verteilen
    targetMembers.forEach(member => {
        const memberQuests = JSON.parse(localStorage.getItem(`lernapp-quests-${member}`) || '[]');
        memberQuests.push({ ...newQuest });
        localStorage.setItem(`lernapp-quests-${member}`, JSON.stringify(memberQuests));
    });
    
    alert(`Quest "${title}" wurde an ${targetMembers.length} Mitglieder verteilt!`);
    closeModal('create-quest-modal');
    
    // Reset form
    document.getElementById('quest-title').value = '';
    document.getElementById('quest-count').value = '10';
    selectQuestSubject('math', { currentTarget: document.querySelector('.subject-tab') });
    selectDifficulty('easy', { currentTarget: document.querySelector('.difficulty-btn') });
}

function showManageAdminsModal(){
    if(!currentUserData.isAdmin){ alert('Nur Admins können andere Admins verwalten'); return; }
    updateAdminManagementList();
    openModal('manage-admins-modal');
}

function updateAdminManagementList(){
    const clubs = JSON.parse(localStorage.getItem('lernapp-clubs') || '{}');
    const users = JSON.parse(localStorage.getItem('lernapp-users') || '{}');
    const club = clubs[currentUserData.clubId];
    const list = document.getElementById('admin-management-list');
    
    list.innerHTML = '';
    if(club && club.members){
        club.members.forEach(member => {
            const isAdmin = club.admins.includes(member);
            const isCreator = club.creator === member;
            
            const div = document.createElement('div');
            div.className = 'member-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:600">${member}${isCreator ? ' 👑' : ''}${isAdmin && !isCreator ? ' 👨‍💼' : ''}</div>
                    <div style="font-size:0.9rem;color:#666">${users[member]?.points || 0} Punkte</div>
                </div>
                <div>
                    ${!isCreator ? `<button class="action-button ${isAdmin ? 'back-btn' : 'check-btn'}" onclick="toggleAdmin('${member}')">${isAdmin ? '➖ Admin entfernen' : '➕ Admin machen'}</button>` : '<span style="color:#f39c12">Ersteller</span>'}
                </div>
            `;
            list.appendChild(div);
        });
    }
}

function toggleAdmin(memberName){
    const clubs = JSON.parse(localStorage.getItem('lernapp-clubs') || '{}');
    const users = JSON.parse(localStorage.getItem('lernapp-users') || '{}');
    const club = clubs[currentUserData.clubId];
    
    if(club.creator === memberName){ alert('Der Ersteller kann nicht entfernt werden'); return; }
    
    const isCurrentlyAdmin = club.admins.includes(memberName);
    
    if(isCurrentlyAdmin){
        club.admins = club.admins.filter(a => a !== memberName);
        users[memberName].isAdmin = false;
        alert(`${memberName} ist kein Admin mehr`);
    } else {
        club.admins.push(memberName);
        users[memberName].isAdmin = true;
        alert(`${memberName} ist jetzt Admin`);
    }
    
    localStorage.setItem('lernapp-clubs', JSON.stringify(clubs));
    localStorage.setItem('lernapp-users', JSON.stringify(users));
    updateAdminManagementList();
}

function showQuestProgressModal(){
    if(!currentUserData.isAdmin){ alert('Nur Admins können den Quest-Fortschritt einsehen'); return; }
    updateQuestProgressList();
    openModal('quest-progress-modal');
}

function updateQuestProgressList(){
    const clubs = JSON.parse(localStorage.getItem('lernapp-clubs') || '{}');
    const club = clubs[currentUserData.clubId];
    const list = document.getElementById('quest-progress-list');
    
    list.innerHTML = '';
    
    if(!club || !club.members){
        list.innerHTML = '<p>Keine Club-Daten gefunden</p>';
        return;
    }
    
    // Sammle alle Quest-Daten der Mitglieder
    const allQuestData = {};
    club.members.forEach(member => {
        const memberQuests = JSON.parse(localStorage.getItem(`lernapp-quests-${member}`) || '[]');
        memberQuests.forEach(quest => {
            if(!allQuestData[quest.id]){
                allQuestData[quest.id] = {
                    title: quest.title,
                    subject: quest.subject,
                    difficulty: quest.difficulty,
                    count: quest.count,
                    members: {}
                };
            }
            allQuestData[quest.id].members[member] = {
                progress: quest.progress,
                completed: quest.completed
            };
        });
    });
    
    if(Object.keys(allQuestData).length === 0){
        list.innerHTML = '<p style="text-align:center;color:#7f8c8d">Keine Quests erstellt</p>';
        return;
    }
    
    Object.values(allQuestData).forEach(questData => {
        const div = document.createElement('div');
        div.style.cssText = 'background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;';
        
        let memberStats = '';
        Object.entries(questData.members).forEach(([member, data]) => {
            const statusClass = data.completed ? 'status-completed' : (data.progress > 0 ? 'status-pending' : 'status-not-started');
            const statusText = data.completed ? 'Abgeschlossen' : (data.progress > 0 ? `${data.progress}/${questData.count}` : 'Nicht begonnen');
            
            memberStats += `
                <div class="member-item" style="margin-bottom:5px">
                    <span>${member}</span>
                    <span class="member-status ${statusClass}">${statusText}</span>
                </div>
            `;
        });
        
        div.innerHTML = `
            <h4>${questData.title}</h4>
            <p>${getSubjectName(questData.subject)} • ${getDifficultyName(questData.difficulty)} • ${questData.count} Aufgaben</p>
            <div style="margin-top:10px">${memberStats}</div>
        `;
        
        list.appendChild(div);
    });
}

/* ===========================
   LEADERBOARD
   =========================== */
async function updateLeaderboard(){
    try{
        const users = JSON.parse(localStorage.getItem('lernapp-users') || '{}');
        const clubs = JSON.parse(localStorage.getItem('lernapp-clubs') || '{}');
        
        const userList = Object.entries(users).map(([name, data]) => ({
            name,
            points: data.points || 0,
            clubName: data.clubName
        })).sort((a,b) => b.points - a.points);
        
        const list = document.getElementById('global-leaderboard');
        list.innerHTML = '';
        
        userList.forEach((user,i) => {
            const li = document.createElement('li');
            li.style.padding='8px';
            li.style.background='#fff';
            li.style.borderRadius='8px';
            li.style.marginBottom='6px';
            li.innerHTML = `<div style="font-weight:700">${i<3? (i===0?'🥇':i===1?'🥈':'🥉') : (i+1)+'.'} ${user.name}${user.name===currentUser?' 👤':''}${user.clubName? ' ('+user.clubName+')':''}</div>
                            <div style="color:var(--info-color);font-weight:700">${user.points}</div>`;
            list.appendChild(li);
        });
    }catch(err){
        console.error(err);
    }
}

function refreshLeaderboard(){ updateLeaderboard(); }

/* ===========================
   LEARNING MODES
   =========================== */
let correctAnswers = 0, wrongAnswers = 0;

function showMathMode(){ 
    hideElement('main-screen'); 
    showElement('math-screen'); 
    document.getElementById('math-mode-title').textContent = currentQuestMode ? `🧮 Quest: ${currentQuestMode.title}` : '🧮 Mathe Trainer';
    setupQuestMode();
    generateNewTask(); 
}

function showGermanMode(){
    hideElement('main-screen'); 
    showElement('math-screen');
    document.getElementById('math-mode-title').textContent = currentQuestMode ? `📝 Quest: ${currentQuestMode.title}` : '📝 Deutsch Trainer';
    setupQuestMode();
    generateGermanTask();
}

function showEnglishMode(){
    hideElement('main-screen'); 
    showElement('math-screen');
    document.getElementById('math-mode-title').textContent = currentQuestMode ? `🇬🇧 Quest: ${currentQuestMode.title}` : '🇬🇧 English Trainer';
    setupQuestMode();
    generateEnglishTask();
}

function setupQuestMode(){
    if(currentQuestMode){
        document.getElementById('quest-progress-display').style.display = 'block';
        updateQuestProgressDisplay();
    } else {
        document.getElementById('quest-progress-display').style.display = 'none';
    }
}

function updateQuestProgressDisplay(){
    if(!currentQuestMode) return;
    document.getElementById('quest-current').textContent = currentQuestMode.progress;
    document.getElementById('quest-total').textContent = currentQuestMode.count;
    const percentage = (currentQuestMode.progress / currentQuestMode.count) * 100;
    document.getElementById('quest-progress-bar').style.width = percentage + '%';
}

function goBack(){ 
    showElement('main-screen'); 
    hideElement('math-screen'); 
    resetGame();
    currentQuestMode = null;
}

function resetGame(){ 
    correctAnswers=0; 
    wrongAnswers=0; 
    document.getElementById('correct-score').textContent='0'; 
    document.getElementById('wrong-score').textContent='0'; 
}

function generateNewTask(){
    if(!currentQuestMode || currentQuestMode.subject !== 'math') return generateMathTask();
    generateMathTask();
}

function generateMathTask(){
    let a, b, operation, question, solution;
    
    const difficulty = currentQuestMode ? currentQuestMode.difficulty : 'easy';
    
    switch(difficulty){
        case 'easy':
            a = Math.floor(Math.random()*10);
            b = Math.floor(Math.random()*10);
            operation = Math.random() < 0.5 ? '+' : '-';
            if(operation === '-' && a < b) [a,b] = [b,a]; // Negative vermeiden
            solution = operation === '+' ? a + b : a - b;
            break;
        case 'medium':
            a = Math.floor(Math.random()*50) + 1;
            b = Math.floor(Math.random()*50) + 1;
            operation = ['+', '-', '*'][Math.floor(Math.random()*3)];
            if(operation === '*') {
                a = Math.floor(Math.random()*12) + 1;
                b = Math.floor(Math.random()*12) + 1;
            }
            if(operation === '-' && a < b) [a,b] = [b,a];
            solution = operation === '+' ? a + b : operation === '-' ? a - b : a * b;
            break;
        case 'hard':
            a = Math.floor(Math.random()*100) + 1;
            b = Math.floor(Math.random()*100) + 1;
            operation = ['+', '-', '*', '/'][Math.floor(Math.random()*4)];
            if(operation === '*') {
                a = Math.floor(Math.random()*25) + 1;
                b = Math.floor(Math.random()*25) + 1;
            }
            if(operation === '/') {
                b = Math.floor(Math.random()*12) + 1;
                solution = Math.floor(Math.random()*20) + 1;
                a = solution * b; // Sorgt für ganzzahlige Division
            } else {
                if(operation === '-' && a < b) [a,b] = [b,a];
                solution = operation === '+' ? a + b : operation === '-' ? a - b : a * b;
            }
            break;
        default:
            a = Math.floor(Math.random()*10);
            b = Math.floor(Math.random()*10);
            operation = '+';
            solution = a + b;
    }
    
    question = `${a} ${operation} ${b} = ?`;
    document.getElementById('question').textContent = question;
    document.getElementById('question').dataset.solution = solution;
    document.getElementById('answer').value = '';
    document.getElementById('answer').focus();
}

function generateGermanTask(){
    const difficulty = currentQuestMode ? currentQuestMode.difficulty : 'easy';
    let tasks = [];
    
    switch(difficulty){
        case 'easy':
            tasks = [
                { question: 'Wie schreibt man "Haus" in der Mehrzahl?', answer: 'Häuser' },
                { question: 'Der/Die/Das... Katze?', answer: 'Die' },
                { question: 'Wie heißt das Gegenteil von "groß"?', answer: 'klein' },
                { question: 'Ergänze: Ich ___ zur Schule. (gehen)', answer: 'gehe' },
                { question: 'Wie viele Buchstaben hat das Alphabet?', answer: '26' }
            ];
            break;
        case 'medium':
            tasks = [
                { question: 'Konjugiere "haben" in der 3. Person Singular:', answer: 'hat' },
                { question: 'Was ist der Genitiv von "der Mann"?', answer: 'des Mannes' },
                { question: 'Ergänze das Adjektiv: Das rot__ Auto', answer: 'rote' },
                { question: 'Wie heißt die Steigerung von "gut"?', answer: 'besser' },
                { question: 'Setze das richtige Pronomen ein: ___ bin müde.', answer: 'Ich' }
            ];
            break;
        case 'hard':
            tasks = [
                { question: 'Bilde das Perfekt: "Ich lese ein Buch"', answer: 'Ich habe ein Buch gelesen' },
                { question: 'Was ist ein Substantiv? (Ein Wort für...)', answer: 'Personen, Tiere oder Dinge' },
                { question: 'Konjugiere "werden" im Präteritum, 1. Person Singular:', answer: 'wurde' },
                { question: 'Ergänze: Trotz d__ Regen__ gehen wir spazieren.', answer: 'des Regens' },
                { question: 'Was bedeutet "Metapher"?', answer: 'Sprachliches Bild' }
            ];
            break;
    }
    
    const task = tasks[Math.floor(Math.random() * tasks.length)];
    document.getElementById('question').textContent = task.question;
    document.getElementById('question').dataset.solution = task.answer.toLowerCase();
    document.getElementById('answer').value = '';
    document.getElementById('answer').focus();
}

function generateEnglishTask(){
    const difficulty = currentQuestMode ? currentQuestMode.difficulty : 'easy';
    let tasks = [];
    
    switch(difficulty){
        case 'easy':
            tasks = [
                { question: 'Translate: "Hund"', answer: 'dog' },
                { question: 'What is the plural of "child"?', answer: 'children' },
                { question: 'Complete: I ___ happy. (am/is/are)', answer: 'am' },
                { question: 'What color is the sun?', answer: 'yellow' },
                { question: 'How do you say "Guten Morgen" in English?', answer: 'good morning' }
            ];
            break;
        case 'medium':
            tasks = [
                { question: 'What is the past tense of "go"?', answer: 'went' },
                { question: 'Complete: She ___ to school yesterday. (go)', answer: 'went' },
                { question: 'What is the opposite of "big"?', answer: 'small' },
                { question: 'Form the comparative of "good":', answer: 'better' },
                { question: 'Complete: I have ___ working here for 5 years.', answer: 'been' }
            ];
            break;
        case 'hard':
            tasks = [
                { question: 'What is the third conditional structure?', answer: 'If + past perfect, would have + past participle' },
                { question: 'Complete: I wish I ___ studied harder. (past)', answer: 'had' },
                { question: 'What is a gerund?', answer: 'verb + ing used as noun' },
                { question: 'Form the passive: "They built the house."', answer: 'The house was built' },
                { question: 'Complete: By next year, I ___ have graduated.', answer: 'will' }
            ];
            break;
    }
    
    const task = tasks[Math.floor(Math.random() * tasks.length)];
    document.getElementById('question').textContent = task.question;
    document.getElementById('question').dataset.solution = task.answer.toLowerCase();
    document.getElementById('answer').value = '';
    document.getElementById('answer').focus();
}

function checkAnswer(){
    const userAnswer = document.getElementById('answer').value.trim();
    const correctAnswer = document.getElementById('question').dataset.solution;
    
    if(!userAnswer){ alert('Bitte eine Antwort eingeben'); return; }
    
    let isCorrect = false;
    
    // Für Mathe: numerischer Vergleich
    if(currentQuestMode && currentQuestMode.subject === 'math' || !currentQuestMode){
        isCorrect = Number(userAnswer) === Number(correctAnswer);
    } else {
        // Für Sprachen: Text-Vergleich (case-insensitive)
        isCorrect = userAnswer.toLowerCase().trim() === correctAnswer.toLowerCase().trim();
    }
    
    if(isCorrect){
        correctAnswers++;
        document.getElementById('correct-score').textContent = correctAnswers;
        
        // Quest-Fortschritt aktualisieren
        if(currentQuestMode){
            currentQuestMode.progress++;
            updateQuestProgressDisplay();
            
            // Quest abgeschlossen?
            if(currentQuestMode.progress >= currentQuestMode.count){
                completeQuest();
                return;
            }
            
            // Quest-Daten speichern
            const questIndex = activeQuests.findIndex(q => q.id === currentQuestMode.id);
            if(questIndex !== -1){
                activeQuests[questIndex] = currentQuestMode;
                saveActiveQuests();
            }
        }
        
        alert('Richtig! 🎉');
    } else {
        wrongAnswers++;
        document.getElementById('wrong-score').textContent = wrongAnswers;
        alert(`Leider falsch. Die richtige Antwort war: ${correctAnswer}`);
    }
    
    // Nächste Aufgabe generieren
    setTimeout(() => {
        if(currentQuestMode && currentQuestMode.subject === 'math'){
            generateMathTask();
        } else if(currentQuestMode && currentQuestMode.subject === 'german'){
            generateGermanTask();
        } else if(currentQuestMode && currentQuestMode.subject === 'english'){
            generateEnglishTask();
        } else {
            generateMathTask(); // Default
        }
    }, 1500);
}

function completeQuest(){
    if(!currentQuestMode) return;
    
    // Quest als abgeschlossen markieren
    currentQuestMode.completed = true;
    const questIndex = activeQuests.findIndex(q => q.id === currentQuestMode.id);
    if(questIndex !== -1){
        activeQuests[questIndex] = currentQuestMode;
        saveActiveQuests();
    }
    
    // Punkte hinzufügen
    const pointsEarned = currentQuestMode.count * 10;
    currentUserData.points = (currentUserData.points || 0) + pointsEarned;
    
    // User-Daten speichern
    const users = JSON.parse(localStorage.getItem('lernapp-users') || '{}');
    users[currentUser] = currentUserData;
    localStorage.setItem('lernapp-users', JSON.stringify(users));
    
    alert(`🎉 Quest abgeschlossen!\n\nDu hast ${pointsEarned} Punkte erhalten!\n\nGesamtpunkte: ${currentUserData.points}`);
    
    updateUserInterface();
    goBack();
}

/* ===========================
   KEYBOARD SHORTCUTS
   =========================== */
document.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && document.getElementById('math-screen').style.display !== 'none'){
        e.preventDefault();
        checkAnswer();
    }
});

/* ===========================
   EXPOSE FUNCTIONS TO GLOBAL SCOPE
   =========================== */
window.showCreateClubModal = showCreateClubModal;
window.showJoinClubModal = showJoinClubModal;
window.createClub = createClub;
window.searchClubs = searchClubs;
window.joinSelectedClub = joinSelectedClub;
window.leaveClub = leaveClub;
window.updateClubInterface = updateClubInterface;
window.updateLeaderboard = updateLeaderboard;
window.refreshLeaderboard = refreshLeaderboard;
window.register = register;
window.login = login;
window.logout = logout;
window.showMathMode = showMathMode;
window.showGermanMode = showGermanMode;
window.showEnglishMode = showEnglishMode;
window.goBack = goBack;
window.checkAnswer = checkAnswer;
window.showTab = showTab;
window.switchTab = switchTab;
window.closeModal = closeModal;
window.showQuestModal = showQuestModal;
window.startQuest = startQuest;
window.showCreateQuestModal = showCreateQuestModal;
window.selectQuestSubject = selectQuestSubject;
window.selectDifficulty = selectDifficulty;
window.createQuest = createQuest;
window.showManageAdminsModal = showManageAdminsModal;
window.toggleAdmin = toggleAdmin;
window.showQuestProgressModal = showQuestProgressModal;

function showSettingsScreen(){
    hideElement('login-screen');
    hideElement('main-screen');
    showElement('settings-screen');
}
function changeUsername(){
    // TODO: API-Call für Namensänderung
    alert('Name geändert!');
}
function changePassword(){
    // TODO: API-Call für Passwortänderung
    alert('Passwort geändert!');
}
function toggleMode(){
    // Dark/Light Mode umschalten
    const isDark = document.getElementById('mode-toggle').checked;
    if(isDark){
        document.body.classList.add('dark-mode');
    }else{
        document.body.classList.remove('dark-mode');
    }
}
function cancelSettings(){
    hideElement('settings-screen');
    showElement('main-screen');
}
function saveSettings(){
    // TODO: Einstellungen speichern
    hideElement('settings-screen');
    showElement('main-screen');
}
</script>
</body>
</html>